<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.aicall.mapper.CcCallPhoneMapper">
    
    <resultMap type="CcCallPhone" id="CcCallPhoneResult">
        <result property="id"    column="id"    />
        <result property="batchId"    column="batch_id"    />
        <result property="telephone"    column="telephone"    />
        <result property="custName"    column="cust_name"    />
        <result property="createtime"    column="createtime"    />
        <result property="callstatus"    column="callstatus"    />
        <result property="calloutTime"    column="callout_time"    />
        <result property="callcount"    column="callcount"    />
        <result property="callEndTime"    column="call_end_time"    />
        <result property="timeLen"    column="time_len"    />
        <result property="validTimeLen"    column="valid_time_len"    />
        <result property="uuid"    column="uuid"    />
        <result property="connectedTime"    column="connected_time"    />
        <result property="hangupCause"    column="hangup_cause"    />
        <result property="answeredTime"    column="answered_time"    />
        <result property="dialogue"    column="dialogue"    />
        <result property="wavfile"    column="wavfile"    />
        <result property="recordServerUrl"    column="record_server_url"    />
        <result property="bizJson"    column="biz_json"    />
        <result property="dialogueCount"    column="dialogue_count"    />
        <result property="acdOpnum"    column="acd_opnum"    />
        <result property="acdQueueTime"    column="dialogue_count"    />
        <result property="acdWaitTime"    column="dialogue_count"    />
        <result property="ttsText"    column="tts_text"    />
    </resultMap>

    <sql id="selectCcCallPhoneVo">
        select id, batch_id, telephone, cust_name, createtime, callstatus, callout_time, callcount, call_end_time, time_len, valid_time_len, uuid, connected_time, hangup_cause, answered_time, dialogue, wavfile, record_server_url, biz_json, dialogue_count, acd_opnum, acd_queue_time, acd_wait_time, tts_text from cc_call_phone
    </sql>

    <select id="selectCcCallPhoneList" parameterType="CcCallPhone" resultMap="CcCallPhoneResult">
        <include refid="selectCcCallPhoneVo"/>
        <where>  
            <if test="batchId != null "> and batch_id = #{batchId}</if>
            <if test="telephone != null  and telephone != ''"> and telephone = #{telephone}</if>
            <if test="custName != null  and custName != ''"> and cust_name = #{custName}</if>
            <if test="callstatus != null "> and callstatus = #{callstatus}</if>
            <if test="params.calloutTimeStart != null and params.calloutTimeStart != ''"><!-- 开始时间检索 -->
                AND callout_time &gt;= #{params.calloutTimeStart}
            </if>
            <if test="params.calloutTimeEnd != null and params.calloutTimeEnd != ''"><!-- 结束时间检索 -->
                AND callout_time &lt;= #{params.calloutTimeEnd}
            </if>
            <if test="params.callEndTimeStart != null and params.callEndTimeStart != ''"><!-- 开始时间检索 -->
                AND call_end_time &gt;= #{params.callEndTimeStart}
            </if>
            <if test="params.callEndTimeEnd != null and params.callEndTimeEnd != ''"><!-- 结束时间检索 -->
                AND call_end_time &lt;= #{params.callEndTimeEnd}
            </if>
            <if test="params.timeLenStart != null and params.timeLenStart != ''"><!-- 开始时间检索 -->
                AND time_len &gt;= #{params.timeLenStart}
            </if>
            <if test="params.timeLenEnd != null and params.timeLenEnd != ''"><!-- 结束时间检索 -->
                AND time_len &lt;= #{params.timeLenEnd}
            </if>
            <if test="params.connectedTimeStart != null and params.connectedTimeStart != ''"><!-- 开始时间检索 -->
                AND connected_time &gt;= #{params.connectedTimeStart}
            </if>
            <if test="params.connectedTimeEnd != null and params.connectedTimeEnd != ''"><!-- 结束时间检索 -->
                AND connected_time &lt;= #{connectedTimeEnd}
            </if>
            <if test="params.answeredTimeStart != null and params.answeredTimeStart != ''"><!-- 开始时间检索 -->
                AND answered_time &gt;= #{params.answeredTimeStart}
            </if>
            <if test="params.answeredTimeEnd != null and params.answeredTimeEnd != ''"><!-- 结束时间检索 -->
                AND answered_time &lt;= #{params.answeredTimeEnd}
            </if>
        </where>
    </select>
    
    <select id="selectCcCallPhoneById" parameterType="String" resultMap="CcCallPhoneResult">
        <include refid="selectCcCallPhoneVo"/>
        where id = #{id}
    </select>

    <insert id="insertCcCallPhone" parameterType="CcCallPhone">
        insert into cc_call_phone
        <trim prefix="(" suffix=")" suffixOverrides=",">
            id,
            batch_id,
            telephone,
            cust_name,
            createtime,
            callstatus,
            callout_time,
            callcount,
            call_end_time,
            time_len,
            valid_time_len,
            uuid,
            connected_time,
            hangup_cause,
            answered_time,
            dialogue,
            wavfile,
            record_server_url,
            biz_json,
            dialogue_count,
            acd_opnum,
            acd_queue_time,
            acd_wait_time,
            tts_text,
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            #{id},
            #{batchId},
            #{telephone},
            #{cust_name},
            #{createtime},
            #{callstatus},
            #{calloutTime},
            #{callcount},
            #{callEndTime},
            #{timeLen},
            #{validTimeLen},
            #{uuid},
            #{connectedTime},
            #{hangupCause},
            #{answeredTime},
            #{dialogue},
            #{wavfile},
            #{recordServerUrl},
            #{bizJson},
            #{dialogueCount},
            #{acdOpnum},
            #{acdQueueTime},
            #{acdWaitTime},
            #{ttsText},
        </trim>
    </insert>

    <update id="updateCcCallPhone" parameterType="CcCallPhone">
        update cc_call_phone
        <trim prefix="SET" suffixOverrides=",">
            batch_id = #{batchId},
            telephone = #{telephone},
            cust_name = #{custName},
            createtime = #{createtime},
            callstatus = #{callstatus},
            callout_time = #{calloutTime},
            callcount = #{callcount},
            call_end_time = #{callEndTime},
            time_len = #{timeLen},
            valid_time_len = #{validTimeLen},
            >uuid = #{uuid},
            connected_time = #{connectedTime},
            hangup_cause = #{hangupCause},
            answered_time = #{answeredTime},
            dialogue = #{dialogue},
            wavfile = #{wavfile},
            record_server_url = #{recordServerUrl},
            biz_json = #{bizJson},
            dialogue_count = #{dialogueCount},
            acd_opnum = #{acdOpnum},
            acd_queue_time = #{acdQueueTime},
            acd_wait_time = #{acdWaitTime},
            tts_text = #{ttsText},
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteCcCallPhoneById" parameterType="String">
        delete from cc_call_phone where id = #{id}
    </delete>

    <delete id="deleteCcCallPhoneByIds" parameterType="String">
        delete from cc_call_phone where id in 
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>


    <select id="statByBatchId" parameterType="Long" resultType="com.ruoyi.aicall.model.CallTaskStatModel">
        SELECT batch_id AS batchId,
               COUNT(1) AS phoneCount,
               SUM(CASE WHEN callout_time > 0 THEN 1 ELSE 0 END) AS callCount,
               SUM(CASE WHEN answered_time > 0 THEN 1 ELSE 0 END) AS connectCount
        FROM cc_call_phone
        WHERE batch_id = #{batchId}
    </select>

    <insert id="batchInsertCcCallPhone" parameterType="java.util.List">
        INSERT INTO cc_call_phone (
        id, batch_id, telephone, cust_name, createtime, callstatus,
        callout_time, callcount, call_end_time, time_len, valid_time_len,
        uuid, connected_time, hangup_cause,
        answered_time, dialogue, wavfile, record_server_url, biz_json,
        dialogue_count,acd_opnum,acd_queue_time,acd_wait_time, tts_text
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.id}, #{item.batchId}, #{item.telephone}, #{item.custName},
            #{item.createtime}, #{item.callstatus}, #{item.calloutTime},
            #{item.callcount}, #{item.callEndTime}, #{item.timeLen},
            #{item.validTimeLen}, #{item.uuid},
            #{item.connectedTime}, #{item.hangupCause},
            #{item.answeredTime}, #{item.dialogue}, #{item.wavfile},
            #{item.recordServerUrl}, #{item.bizJson}, #{item.dialogueCount},
            #{item.acdOpnum}, #{item.acdQueueTime}, #{item.acdWaitTime}, #{item.ttsText}
            )
        </foreach>
    </insert>
</mapper>